// Alternative import method - add this at the top of your server.js
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;

const supabase = createClient(supabaseUrl, supabaseKey);



// pecp-server/server.js - ENHANCED VERSION
const express = require('express');
const cors = require('cors');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// CORS Configuration - More permissive for development
const corsOptions = {
  origin: ['http://localhost:3000', 'http://localhost:3001', 'http://127.0.0.1:3000'],
  credentials: true,
  optionsSuccessStatus: 200,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};

// Middleware
app.use(cors(corsOptions));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Add request logging middleware
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  if (req.method === 'POST' || req.method === 'PUT') {
    console.log('Request body:', JSON.stringify(req.body, null, 2));
  }
  next();
});

// Root route
app.get('/', (req, res) => {
  res.json({
    message: "ðŸš€ PECP Server API is running!",
    status: "active",
    endpoints: [
      "GET /api/employees - Get all employees",
      "POST /api/employees - Create employee", 
      "GET /api/employees/:id - Get single employee",
      "PUT /api/employees/:id - Update employee",
      "DELETE /api/employees/:id - Delete employee",
      "GET /api/admin - Get admin data", 
      "GET /api/test - Test connection"
    ],
    timestamp: new Date().toISOString()
  });
});

// Enhanced test endpoint
app.get('/api/test', (req, res) => {
  res.json({
    message: "âœ… Backend connection successful!",
    server: "pecp-server",
    timestamp: new Date().toISOString()
  });
});

// Import routes
const adminRoutes = require('./routes/adminRoutes');
const employeeRoutes = require('./routes/employeeRoutes');

// Use routes
app.use('/api/admin', adminRoutes);
app.use('/api/employees', employeeRoutes);

// pecp-server/server.js

// Add this code BEFORE app.listen() at the bottom of your server.js file


// POST /api/employee/leave
app.post('/api/employee/leave', async (req, res) => {
 // pecp-server/server.js

// Your existing imports and setup at the top
const express = require('express');
const cors = require('cors');
// ... other imports ...

// Your existing middleware and routes
app.use(cors());
app.use(express.json());
// ... existing routes like /api/employees, /api/admin, etc...

// ADD/REPLACE THIS SECTION - The corrected leave request routes
const { supabase } = require('./config/supabaseClient.js'); // Make sure this import is correct

// REPLACE your existing broken POST route with this:
app.post('/api/employee/leave', async (req, res) => {
  try {
    const { user_id, fromDate, toDate, reason } = req.body;

    console.log('Leave request data received:', { user_id, fromDate, toDate, reason });

    // Validation
    if (!user_id || !fromDate || !toDate || !reason) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields: user_id, fromDate, toDate, reason'
      });
    }

    // Validate UUID format
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(user_id)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid user_id format. Must be a valid UUID'
      });
    }

    // Check if dates are valid
    const fromDate_obj = new Date(fromDate);
    const toDate_obj = new Date(toDate);
    
    if (fromDate_obj > toDate_obj) {
      return res.status(400).json({
        success: false,
        error: 'From date cannot be later than to date'
      });
    }

    // Check if supabase is properly loaded
    if (!supabase) {
      console.error('Supabase client not initialized');
      return res.status(500).json({
        success: false,
        error: 'Database connection not available'
      });
    }

    // Check if user exists
    const { data: employee, error: employeeError } = await supabase
      .from('employees')
      .select('id, name, employee_id')
      .eq('id', user_id)
      .single();

    if (employeeError || !employee) {
      console.log('Employee not found:', employeeError);
      return res.status(404).json({
        success: false,
        error: 'Employee not found',
        details: employeeError?.message
      });
    }

    // Insert leave request
    const { data, error } = await supabase
      .from('leave_requests')
      .insert([
        {
          user_id: user_id,
          from_date: fromDate,
          to_date: toDate,
          reason: reason,
          status: 'pending'
        }
      ])
      .select('*')
      .single();

    if (error) {
      console.error('Supabase insert error:', error);
      return res.status(500).json({
        success: false,
        error: 'Failed to create leave request',
        details: error.message
      });
    }

    return res.status(201).json({
      success: true,
      message: 'Leave request submitted successfully',
      data: data
    });

  } catch (error) {
    console.error('API error:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error',
      details: error.message
    });
  }
});

// Your existing app.listen() at the bottom
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

});

// GET /api/employee/leave
app.get('/api/employee/leave', async (req, res) => {
  try {
    const { user_id, status } = req.query;

    let query = supabase
      .from('leave_requests')
      .select(`
        *,
        employees!user_id (
          name,
          employee_id,
          phone
        )
      `)
      .order('created_at', { ascending: false });

    if (user_id) {
      query = query.eq('user_id', user_id);
    }

    if (status) {
      query = query.eq('status', status);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Supabase error:', error);
      return res.status(500).json({
        success: false,
        error: 'Failed to fetch leave requests',
        details: error.message
      });
    }

    return res.json({
      success: true,
      data: data,
      count: data.length
    });

  } catch (error) {
    console.error('API error:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error',
      details: error.message
    });
  }
});

// PUT /api/employee/leave
app.put('/api/employee/leave', async (req, res) => {
  try {
    const { id, status, comments, reviewed_by } = req.body;

    if (!id || !status) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields: id, status'
      });
    }

    if (!['approved', 'rejected'].includes(status)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid status. Must be approved or rejected'
      });
    }

    const { data, error } = await supabase
      .from('leave_requests')
      .update({
        status: status,
        comments: comments || null,
        reviewed_by: reviewed_by || null,
        reviewed_date: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('id', id)
      .select(`
        *,
        employees!user_id (
          name,
          employee_id,
          phone
        )
      `)
      .single();

    if (error) {
      console.error('Supabase error:', error);
      return res.status(500).json({
        success: false,
        error: 'Failed to update leave request',
        details: error.message
      });
    }

    return res.json({
      success: true,
      message: `Leave request ${status} successfully`,
      data: data
    });

  } catch (error) {
    console.error('API error:', error);
    return res.status(500).json({
      success: false,
      error: 'Internal server error',
      details: error.message
    });
  }
});

// Your existing app.listen() should be here at the bottom


// Enhanced server startup
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on http://localhost:${PORT}`);
  console.log(`ðŸ“¡ API endpoints available:`);
  console.log(`   - GET  http://localhost:${PORT}/ (Server info)`);
  console.log(`   - GET  http://localhost:${PORT}/api/test (Test connection)`);
  console.log(`   - GET  http://localhost:${PORT}/api/employees (Get employees)`);
  console.log(`   - POST http://localhost:${PORT}/api/employees (Create employee)`);
  console.log(`   - GET  http://localhost:${PORT}/api/admin (Get admin data)`);
  console.log(`âœ¨ Ready to accept requests with full logging!`);
});

// Handle unmatched routes
app.use('*', (req, res) => {
  res.status(404).json({
    error: 'Route not found',
    message: `Cannot ${req.method} ${req.originalUrl}`,
    availableEndpoints: [
      'GET /',
      'GET /api/test',
      'GET /api/employees',
      'POST /api/employees',
      'GET /api/admin'
    ]
  });
});

module.exports = app;
